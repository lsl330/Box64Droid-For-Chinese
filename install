clear
rm -f Chinese-LANG-Pack.tar.xz
echo -e " Box64Droid中文化补丁..."
echo -e " 本补丁除了中文环境外，还会包含一些额外的便捷功能"
echo -e " 补丁下载中"
wget -q --show-progress https://github.com/lsl330/Box64Droid-For-Chinese/releases/download/Chinese-LANG-Pack/Chinese-LANG-Pack.tar.xz
tar -xf Chinese-LANG-Pack.tar.xz
rm -f Chinese-LANG-Pack.tar.xz
echo -e " 移动补丁到ubuntu目录"
rm -rf $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/Chinese-LANG-Pack
mv -f Chinese-LANG-Pack $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/
echo -e " 复制字体文件"
cp -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/Chinese-LANG-Pack/SimSun.ttc $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/wine/share/wine/fonts/SimSun.ttc
cp -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/Chinese-LANG-Pack/PMingLiU-TW.ttf $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/wine/share/wine/fonts/PMingLiU-TW.ttf
cp -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/Chinese-LANG-Pack/locale-archive-cn $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/usr/lib/locale/locale-archive
echo -e " 替换bashrc为中文环境"
sed -i 's/en_US/zh_CN/g;s/zh_TW/zh_CN/g;s/ja_JP/zh_CN/g' $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/.bashrc
echo -e " 替换TFM为中文版"
cp -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/Chinese-LANG-Pack/TFM.exe $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/TFM.exe
echo -e " 起点位置添加快捷启动项"
cp -rf $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/Chinese-LANG-Pack/Shortcuts $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt
cp -rf $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/Shortcuts/*  "$PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/root/.wine/drive_c/ProgramData/Microsoft/Windows/Start Menu"
if cat $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/tools/changewinever |grep 替换 > /dev/null
then
	echo -e " changewinever已更新，无需替换"
else
	echo -e " 下载changewinever替换文件"
  wget https://raw.githubusercontent.com/lsl330/Box64Droid-For-Chinese/main/modifychangewinever &>/dev/null
  echo -e " 更新changewinever"
  printf "%s\n" "/WINEDLLOVERRIDES/r modifychangewinever" w | ed -s $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/tools/changewinever
  echo -e " 更新changewinever成功"
  rm -f modifychangewinever
fi
if cat $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf |grep proot > /dev/null
then
	echo -e " 已打proot突破限制补丁"
else
	echo -e " 备份proot限制文件"
	cp -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf.bakup
	echo -e " 突破proot连接数限制"
	echo -e >> $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf
	echo "#unlock proot limit" >> $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf
	echo "root - nofile 24576" >> $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf
	echo "root - memlock 36784" >> $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf
	echo "root - sigpending 36784" >> $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/etc/security/limits.conf
fi
echo -e " 下载语言环境切换文件"
wget https://raw.githubusercontent.com/lsl330/Box64Droid-For-Chinese/main/lang &>/dev/null
chmod +x lang
mv -f lang $PREFIX/bin/lang
echo -e " 配置语言环境切换文件，以后在termux上运行lang即可切换语言环境"
if [ -f "$PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start" ]; then
	if cat $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start |grep 自定义 > /dev/null;then
		echo -e " start已更新，无需更改"
	else
		echo -e " 修改start文件"
		for((i=1;i<=30;i++)); do
		 if cat $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start|head -n $i|grep TFM > /dev/null; then
			cb=$i
			break
		 fi
		done 
		sed -i "$cb a fi" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
		sed -i "$cb i else" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
		sed -i "$cb i WINEDEBUG=-all taskset -c 4-7 box64 wine explorer /desktop=shell,$res /root/.wine/dosdevices/d:/run.bat &>/dev/null &" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
		sed -i "$cb i echo -e "运行自定义run.bat"" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
		sed -i "$cb i echo -e if [ -f "/root/.wine/dosdevices/d:/run.bat" ]; then" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start

		for((i=1;i<=30;i++)); do
		 if cat $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start|head -n $i|grep read\ choice > /dev/null; then
			ca=$i
			break
		 fi
		done 
		sed -i "$ca a fi" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
		sed -i "$ca i else" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
		sed -i "$ca i choice=1" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
		sed -i "$ca i if [ -f "/opt/quickstart" ]; then" $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/start
	fi
fi
if [ -f "$PREFIX/bin/start-box" ]; then
	if cat $PREFIX/bin/start-box |grep opt/resolution > /dev/null; then
		echo -e " start-box已更新，无需更改"
	else
		cp -f $PREFIX/bin/start-box $PREFIX/bin/pbox
		echo -e " 修改start-box文件，正确启动后，以后可用pbox进行快捷启动"
		sed -i "2irm -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/resolution" start-box
		sed -i "2irm -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/qucikstart" start-box
		sed -i "2iecho 1>$PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/qucikstart" pbox
	fi
fi
if [ -f "$PREFIX/bin/start-box-virgl" ]; then
	if cat $PREFIX/bin/start-box-virgl |grep resolution > /dev/null; then
		echo -e " start-box-virgl已更新，无需更改"
	else
		cp -f $PREFIX/bin/start-box $PREFIX/bin/vbox
		echo -e " 修改start-box-virgl文件，正确启动后，以后可用vbox进行快捷启动"
		sed -i "2irm -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/resolution" start-box-virgl
		sed -i "2irm -f $PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/qucikstart" start-box-virgl
		sed -i "2iecho 1>$PREFIX/var/lib/proot-distro/installed-rootfs/ubuntu/opt/qucikstart" vbox
	fi
fi
echo -e " 安装完成"
rm -f install
